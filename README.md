# U108_Discovery_Schemas



## Adding a new version

1. File a MR for your changes
    * Make sure your MR title follows conventional commit guidelines.
2. Once the MR is reviewed and merged, the pipeline will tag and release a new version.

If you want to use the new version, then run:
`poetry add --source gitlab shared-schemas==<version_num>`
or
`poetry add --source gitlab shared-schemas@latest`


## Using the latest version in your code
### Add the package for local dev

Add the GitLab package registry as a secondary source in your Poetry config 
```shell
poetry source add --secondary gitlab https://gitlab.com/api/v4/projects/46035419/packages/pypi/simple
```

Create a GitLab personal access token with the `api` scope enabled. Guide: https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html

Configure poetry with your credentials
```shell
poetry config http-basic.gitlab <token_name> <token_value>
```

Install the package:
```shell
poetry add --source gitlab shared-schemas
```

You should then be able to import the contents in your code as follows
```python
from schemas.signal import SignalSchema
signal = SignalSchema(...)
```

### Add the package to your CI pipeline

You will need to pass token credentials to Dockerfiles with dependencies on
this package.

These can be generated by creating a deploy token in GitLab with the `read_package_registry` scope.
Guide: https://docs.gitlab.com/ee/user/project/deploy_tokens/

Once done, update your Dockerfile to take build args for the token name and 
value, then configure Poetry as above:
```dockerfile
ARG PACKAGE_TOKEN_NAME=""
ENV PACKAGE_TOKEN_NAME=$PACKAGE_TOKEN_NAME
ARG PACKAGE_TOKEN_VALUE=""
ENV PACKAGE_TOKEN_NAME=$PACKAGE_TOKEN_VALUE

...
RUN poetry config http-basic.gitlab $PACKAGE_TOKEN_NAME $PACKAGE_TOKEN_VALUE
...
```

In your `.gitlab-ci.yml` file, pass these values to `docker build`:
```shell
docker build --build-arg PACKAGE_TOKEN_NAME=$PACKAGE_PULL_TOKEN_NAME --build-arg PACKAGE_TOKEN_VALUE=$PACKAGE_PULL_TOKEN_VALUE
```

`PACKAGE_PULL_TOKEN_NAME` and `PACKAGE_PULL_TOKEN_VALUE` should be set as
CI/CD variables in GitLab that match the deploy token name and value.
